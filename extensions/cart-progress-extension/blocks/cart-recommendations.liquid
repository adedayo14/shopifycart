{% comment %}
  Cart Recommendations Block - Horizontal Scrollable
  File: extensions/cart-recommendations-extension/blocks/cart-recommendations.liquid
{% endcomment %}

{{ 'cart-recommendations.css' | asset_url | stylesheet_tag }}

<div class="cart-recommendations-section">
  <div class="recommendations-header">
    <h3 class="recommendations-title">
      {{ block.settings.title | default: 'RECOMMENDED FOR YOU' }}
    </h3>
    {% if block.settings.collapsible %}
      <button class="recommendations-toggle" aria-label="Toggle" aria-expanded="true">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 7.5L10 12.5L15 7.5"/>
        </svg>
      </button>
    {% endif %}
  </div>

  <div class="recommendations-container-wrapper" style="position:relative;"
       data-success-enabled="{{ block.settings.show_success_feedback }}"
       data-success-color="{{ block.settings.success_feedback_color }}"
       data-hide-in-cart="{{ block.settings.hide_in_cart }}">
  {% if block.settings.show_arrows %}
      <div class="carousel-controls fixed" data-for="{{ block.id }}">
        <button class="carousel-arrow prev" aria-label="Previous">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5l-5 5 5 5"/>
          </svg>
        </button>
        <button class="carousel-arrow next" aria-label="Next">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 5l5 5-5 5"/>
          </svg>
        </button>
      </div>
    {% endif %}
    <div class="recommendations-container" data-block-id="{{ block.id }}">
    <div class="recommendations-track">
      {% comment %} Get products based on source {% endcomment %}
      {% if block.settings.source == 'collection' and block.settings.collection %}
        {% assign recommendations = block.settings.collection.products %}
        {% assign max_products = 8 %}
      {% elsif block.settings.source == 'manual' %}
        {% comment %} Use manually selected products from product_list {% endcomment %}
        {% assign recommendations = '' | split: '' %}
        {% if block.settings.manual_products != blank %}
          {% assign recommendations = block.settings.manual_products %}
        {% endif %}
        {% assign max_products = 8 %}
      {% else %}
        {% comment %} Default fallback collection list (limit later) {% endcomment %}
        {% assign recommendations = collections.all.products %}
        {% assign max_products = 4 %}
      {% endif %}

      {% comment %} Get current cart item IDs for hiding {% endcomment %}
      {% assign cart_product_ids = cart.items | map: 'product_id' %}

  {% for product in recommendations limit: max_products %}
        {% comment %} Check if product should be hidden {% endcomment %}
        {% assign should_hide = false %}
        {% if block.settings.hide_in_cart %}
          {% if cart_product_ids contains product.id %}
            {% assign should_hide = true %}
          {% endif %}
        {% endif %}

  {% unless should_hide %}
          <div class="recommendation-card" data-product-id="{{ product.id }}">
            <div class="card-content">
              <a href="{{ product.url }}" class="product-image product-link" aria-label="View {{ product.title }}">
                {% if product.featured_image %}
                  {{ product.featured_image | image_url: width: 300 | image_tag: loading: 'lazy', alt: product.title, class: 'recommendation-image' }}
                {% else %}
                  {{ 'product-' | append: forloop.index | placeholder_svg_tag }}
                {% endif %}
              </a>
              
              <div class="product-info">
                <h4 class="product-name"><a href="{{ product.url }}" class="product-link">{{ product.title }}</a></h4>
                <p class="product-price">{{ product.price | money }}</p>
                
                {% if product.has_only_default_variant == false %}
                  {% comment %} Color swatches {% endcomment %}
                  <div class="color-options">
                    {% assign rendered_colors_tracker = '|' %}
                    {% assign color_count = 0 %}
                    {% for variant in product.variants %}
                      {% if color_count >= 7 %}{% break %}{% endif %}
                      {% assign color_value = variant.option1 %}
                      {% assign search_token = '|' | append: color_value | append: '|' %}
                      {% if color_value and rendered_colors_tracker contains search_token %}
                        {% continue %}
                      {% endif %}
                      {% assign rendered_colors_tracker = rendered_colors_tracker | append: color_value | append: '|' %}
                      {% assign color_handle = color_value | handleize %}
                      <button class="color-swatch {% if color_count == 0 %}active{% endif %}"
                              data-color="{{ color_value }}"
                              data-variant-id="{{ variant.id }}"
                              aria-label="{{ color_value }}"
                              style="--swatch-color: var(--color-{{ color_handle }}, #{{ color_handle | remove: '-' | truncate: 6, '' }});">
                      </button>
                      {% assign color_count = color_count | plus: 1 %}
                    {% endfor %}
                  </div>

                  {% comment %} Size selector and add button in one row {% endcomment %}
                  <div class="product-actions">
                    {% assign second_option_name = product.options[1] | default: 'Option' %}
                    <select class="size-select" data-product-id="{{ product.id }}">
                      <option value="">Select {{ second_option_name }}</option>
                      {% for variant in product.variants %}
                        {% if variant.available %}
                          <option value="{{ variant.id }}" data-price="{{ variant.price | money }}">
                            {{ variant.option2 | default: variant.title }}
                          </option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    <button class="add-btn"
                            data-product-id="{{ product.id }}"
                            data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                      Add+
                    </button>
                  </div>
                {% else %}
                  {% comment %} Simple product with single variant {% endcomment %}
                  <div class="product-actions single">
                    <button class="add-btn full-width" 
                            data-product-id="{{ product.id }}"
                            data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                      Add+
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endunless %}
      {% endfor %}
    </div>
    
    </div>
  </div>
</div>

<script src="{{ 'cart-recommendations.js' | asset_url }}" defer></script>

<style>
  /* Dynamic color swatches */
  .color-swatch {
    --color-white: #ffffff;
    --color-black: #000000;
    --color-grey: #808080;
    --color-gray: #808080;
    --color-navy: #001f3f;
    --color-blue: #0074d9;
    --color-blizzard: #f0f8ff;
    --color-natural-black: #1a1a1a;
    --color-pink: #ff69b4;
    --color-beige: #f5f5dc;
    --color-tan: #d2b48c;
    --color-brown: #8b4513;
    --color-green: #2ecc40;
    --color-olive: #3d9970;
  }
</style>

{% schema %}
{
  "name": "Cart Recommendations",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "RECOMMENDED FOR YOU"
    },
    {
      "type": "select",
      "id": "source",
      "label": "Product Source",
      "options": [
        {
          "value": "collection",
          "label": "From Collection"
        },
        {
          "value": "manual",
          "label": "Manual Selection"
        }
      ],
      "default": "collection"
    },
    {
      "type": "header",
      "content": "Collection Selection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select a collection for automatic recommendations"
    },
    {
      "type": "header",
      "content": "Manual Product Selection"
    },
    {
      "type": "product_list",
      "id": "manual_products",
      "label": "Select Products",
      "info": "Choose up to 8 products to recommend",
      "limit": 8
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "checkbox",
      "id": "hide_in_cart",
      "label": "Hide products already in cart",
      "default": true,
      "info": "Don't show recommended products that are already in the customer's cart"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_success_feedback",
      "label": "Show success toast on add",
      "default": true
    },
    {
      "type": "color",
      "id": "success_feedback_color",
      "label": "Success feedback color",
      "default": "#22c55e"
    },
    {
      "type": "checkbox",
      "id": "collapsible",
      "label": "Collapsible Section",
      "default": true
    }
  ]
}
{% endschema %}