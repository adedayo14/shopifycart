{% comment %}
Cart Product Recommendations Block
File: extensions/cart-progress-extension/blocks/cart-recommendations.liquid
Aligned with cart progress bar design
{% endcomment %}

{{ 'cart-progress.css' | asset_url | stylesheet_tag }}

{%- assign layout_mode = block.settings.layout | default: 'list' -%}
{%- assign max_products = block.settings.max_products | default: 4 -%}
{%- assign recommendations_title = block.settings.recommendations_title | default: 'RECOMMENDED FOR YOU' -%}
{%- assign add_button_text = block.settings.add_button_text | default: 'Add+' -%}

<!-- Cart Recommendations Component -->
{% if block.settings.recommendation_products.size > 0 or request.design_mode %}
<div class="cart-recommendations-container cart-recommendations-visible {{ layout_mode }}" 
     data-cart-recommendations
     data-block-id="{{ block.id }}"
     data-layout="{{ layout_mode }}"
     data-auto-hide="{{ block.settings.auto_hide_in_cart }}"
     data-max-products="{{ max_products }}">

  <div class="cart-recommendations-header">
    <span class="cart-recommendations-title">{{ recommendations_title }}</span>
    {% if block.settings.show_toggle %}
      <button class="cart-recommendations-toggle" 
              aria-expanded="true" 
              aria-controls="cart-recommendations-content"
              data-toggle-recommendations>
        <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    {% endif %}
  </div>
  
  <div class="cart-recommendations-content" 
       id="cart-recommendations-content" 
       data-recommendations-content
       {% unless block.settings.show_toggle %}style="max-height: none; overflow: visible;"{% endunless %}>
    
    {% if block.settings.recommendation_products.size > 0 %}
      <div class="recommendations-grid {{ layout_mode }}">
        {% for product in block.settings.recommendation_products limit: max_products %}
          {% assign first_variant = product.variants.first %}
          {% assign available = first_variant.available %}
          
          <div class="recommendation-item {% unless available %}out-of-stock{% endunless %}" 
               data-product-id="{{ product.id }}"
               data-variant-id="{{ first_variant.id }}"
               data-product-handle="{{ product.handle }}">
            
            <div class="rec-image-wrapper">
              {% if product.featured_image %}
                <img class="rec-image" 
                     src="{{ product.featured_image | image_url: width: 120, height: 120, crop: 'center' }}" 
                     alt="{{ product.title }}" 
                     loading="lazy" 
                     width="120" 
                     height="120">
              {% else %}
                <div class="rec-image-placeholder">
                  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <path d="M21 15l-5-5L5 21"/>
                  </svg>
                </div>
              {% endif %}
            </div>
            
            <div class="rec-details">
              <h4 class="rec-title">{{ product.title | truncate: 40 }}</h4>
              
              {% if block.settings.show_prices %}
                <div class="rec-price">
                  {% if first_variant.compare_at_price and first_variant.compare_at_price > first_variant.price %}
                    <span class="rec-price-compare">{{ first_variant.compare_at_price | money }}</span>
                    <span class="rec-price-sale">{{ first_variant.price | money }}</span>
                  {% else %}
                    <span class="rec-price-regular">{{ first_variant.price | money }}</span>
                  {% endif %}
                </div>
              {% endif %}
              
              {% if block.settings.show_variants and product.variants.size > 1 %}
                <div class="rec-variants" data-product-variants="{{ product.id }}">
                  {% for option in product.options limit: 2 %}
                    {% assign option_name = option.name | downcase %}
                    
                    {% if option_name contains 'color' and option.values.size <= 6 %}
                      <div class="variant-option color-swatches">
                        <span class="variant-label">{{ option.name }}:</span>
                        <div class="swatch-container">
                          {% for value in option.values limit: 6 %}
                            <button class="color-swatch {% if forloop.first %}selected{% endif %}" 
                                    data-option-name="{{ option.name }}"
                                    data-option-value="{{ value }}"
                                    data-option-position="{{ option.position }}"
                                    title="{{ value }}">
                              <span class="swatch-color" style="background-color: {{ value | handleize }};"></span>
                            </button>
                          {% endfor %}
                        </div>
                      </div>
                      
                    {% elsif option_name contains 'size' %}
                      <div class="variant-option size-selector">
                        <span class="variant-label">{{ option.name }}:</span>
                        <select class="size-select" 
                                data-option-name="{{ option.name }}"
                                data-option-position="{{ option.position }}">
                          {% for value in option.values %}
                            <option value="{{ value }}">{{ value }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
              
              <button class="rec-add-btn {% unless available %}disabled{% endunless %}" 
                      data-variant-id="{{ first_variant.id }}" 
                      data-product-id="{{ product.id }}"
                      data-product-title="{{ product.title | escape }}"
                      data-product-handle="{{ product.handle }}"
                      {% unless available %}disabled{% endunless %}>
                {% if available %}
                  <span class="btn-text">{{ add_button_text }}</span>
                  <span class="btn-loading" style="display: none;">
                    <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                  </span>
                {% else %}
                  <span class="btn-text">Sold Out</span>
                {% endif %}
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    
    {% elsif request.design_mode %}
      <!-- Theme Editor Fallback when no products selected -->
      <div class="recommendations-grid {{ layout_mode }}">
        <div class="recommendation-item theme-editor-placeholder">
          <div class="rec-image-wrapper">
            <div class="rec-image-placeholder">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
            </div>
          </div>
          <div class="rec-details">
            <h4 class="rec-title">Sample Product</h4>
            <div class="rec-price">
              <span class="rec-price-regular">$29.99</span>
            </div>
            <button class="rec-add-btn disabled" disabled>
              <span class="btn-text">Add+</span>
            </button>
          </div>
        </div>
        
        <div class="recommendation-item theme-editor-placeholder">
          <div class="rec-image-wrapper">
            <div class="rec-image-placeholder">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
            </div>
          </div>
          <div class="rec-details">
            <h4 class="rec-title">Another Product</h4>
            <div class="rec-price">
              <span class="rec-price-compare">$49.99</span>
              <span class="rec-price-sale">$39.99</span>
            </div>
            <button class="rec-add-btn disabled" disabled>
              <span class="btn-text">Add+</span>
            </button>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; font-size: 14px; color: #0c4a6e;">
        üìù <strong>Theme Editor:</strong> Select products in the "Recommended Products" setting to display real recommendations.
      </div>
    {% endif %}
  </div>
</div>

{%- comment -%} Auto-inject into cart drawers {%- endcomment -%}
{% render 'cart-drawer-auto-inject' %}

{% endif %}

<script src="{{ 'cart-progress.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Cart Recommendations",
  "target": "section",
  "templates": ["cart", "index", "product", "collection"],
  "settings": [
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Section Title",
      "default": "RECOMMENDED FOR YOU",
      "info": "Title shown above recommended products"
    },
    {
      "type": "product_list",
      "id": "recommendation_products",
      "label": "Recommended Products",
      "limit": 12,
      "info": "Select up to 12 products to recommend to customers"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Max Products to Show",
      "min": 1,
      "max": 12,
      "default": 4,
      "step": 1,
      "info": "Maximum number of products to display at once"
    },
    {
      "type": "text",
      "id": "add_button_text",
      "label": "Add Button Text",
      "default": "Add+",
      "info": "Text shown on add to cart buttons"
    },
    {
      "type": "header",
      "content": "Display Options"
    },
    {
      "type": "checkbox",
      "id": "show_prices",
      "label": "Show Product Prices",
      "default": true,
      "info": "Display product prices including sale prices"
    },
    {
      "type": "checkbox",
      "id": "show_variants",
      "label": "Show Color/Size Options",
      "default": true,
      "info": "Allow customers to select product variants"
    },
    {
      "type": "checkbox",
      "id": "show_toggle",
      "label": "Show Collapse/Expand Toggle",
      "default": true,
      "info": "Add a toggle button to collapse/expand the recommendations"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout Style",
      "default": "list",
      "options": [
        {
          "label": "List (Stacked rows)",
          "value": "list"
        },
        {
          "label": "Grid (2 columns)",
          "value": "grid-2"
        },
        {
          "label": "Grid (3 columns)",
          "value": "grid-3"
        }
      ],
      "info": "Choose how products are displayed"
    },
    {
      "type": "header",
      "content": "Behavior"
    },
    {
      "type": "checkbox",
      "id": "auto_hide_in_cart",
      "label": "Hide products already in cart",
      "default": false,
      "info": "Automatically hide recommended products that are already added to cart"
    }
  ]
}
{% endschema %}
