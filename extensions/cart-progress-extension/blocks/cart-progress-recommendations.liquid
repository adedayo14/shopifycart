{% comment %} File: extensions/cart-progress-extension/blocks/cart-progress-recommendations.liquid {% endcomment %}
{% comment %}
Modern Cart Progress & Recommendations System
Features:
 - Multi-tier progress bar (Free Shipping / Gift / Discount)
 - Product recommendations (up to 5 products)
 - Toggle visibility for each section
 - Accessible design with ARIA support
 - Mobile-responsive layout
{% endcomment %}

{{ 'cart-progress.css' | asset_url | stylesheet_tag }}

<div class="cart-drawer-content" id="cart-progress-root" data-app="cart-progress">
  
  <!-- Cart Header -->
  <div class="cart-header">
    <h2 class="cart-title">CART ({{ cart.item_count }})</h2>
    <button class="cart-close" aria-label="Close cart">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <!-- Progress Bar Section -->
  {% if block.settings.show_progress_bar %}
  <div class="progress-section">
    <div id="progress-bar-container"
         class="cart-progress-bar"
         role="progressbar"
         aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"
         data-free-threshold="{{ block.settings.free_shipping_threshold }}"
         data-gift-threshold="{{ block.settings.gift_threshold | default: 0 }}"
         data-discount-threshold="{{ block.settings.discount_threshold | default: 0 }}"
         data-discount-code="{{ block.settings.discount_code }}"
         data-gift-product-id="{{ block.settings.gift_product_id }}"
         data-hide-when-complete="{{ block.settings.hide_when_complete }}"
         data-currency-symbol="{{ cart.currency.symbol }}">
      
      <div class="progress-track">
        <div class="progress-fill" 
             style="--progress-color: {{ block.settings.progress_color }}; --track-color: {{ block.settings.track_color }};"></div>
      </div>
      
      <p class="progress-message" id="cart-progress-message" role="status" aria-live="polite">
        {{ block.settings.initial_message }}
      </p>
    </div>
  </div>
  {% endif %}

  <!-- Cart Items -->
  <div class="cart-items-section">
    {% for item in cart.items %}
    <div class="cart-item" data-key="{{ item.key }}">
      <div class="item-image">
        {% if item.image %}
          <img src="{{ item.image | image_url: width: 80, height: 80, crop: 'center' }}" alt="{{ item.title }}" loading="lazy" width="80" height="80">
        {% else %}
          <div class="item-image-placeholder"></div>
        {% endif %}
      </div>
      
      <div class="item-details">
        <h3 class="item-title">{{ item.product.title | upcase }}</h3>
        {% if item.variant.option1 and item.variant.option1 != 'Default Title' %}
          <p class="item-variant">Color: {{ item.variant.option1 }}</p>
        {% endif %}
        {% if item.variant.option2 %}
          <p class="item-variant">Size: {{ item.variant.option2 }}</p>
        {% endif %}
        
        <div class="item-quantity">
          <button class="qty-btn qty-decrease" data-key="{{ item.key }}" aria-label="Decrease quantity">âˆ’</button>
          <input type="number" class="qty-input" value="{{ item.quantity }}" min="1" data-key="{{ item.key }}">
          <button class="qty-btn qty-increase" data-key="{{ item.key }}" aria-label="Increase quantity">+</button>
        </div>
      </div>
      
      <div class="item-actions">
        <span class="item-price">{{ item.final_price | money }}</span>
        <button class="item-remove" data-key="{{ item.key }}" aria-label="Remove item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Recommendations Section -->
  {% if block.settings.show_recommendations and block.settings.recommendation_products.size > 0 %}
  <div class="recommendations-section" id="recommendations-section">
    <div class="recommendations-header">
      <h3 class="recommendations-title">{{ block.settings.recommendations_title }}</h3>
      <button class="recommendations-toggle" aria-expanded="true" aria-controls="recommendations-content">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <div class="recommendations-content" id="recommendations-content">
      {% for product in block.settings.recommendation_products limit: 5 %}
        {% assign first_variant = product.variants.first %}
        <div class="recommendation-item" data-product-id="{{ product.id }}">
          <div class="rec-image">
            {% if product.featured_image %}
              <img src="{{ product.featured_image | image_url: width: 120, height: 120, crop: 'center' }}" alt="{{ product.title }}" loading="lazy" width="120" height="120">
            {% else %}
              <div class="rec-image-placeholder"></div>
            {% endif %}
          </div>
          
          <div class="rec-details">
            <h4 class="rec-title">{{ product.title }}</h4>
            <p class="rec-price">{{ first_variant.price | money }}</p>
            
            {% if product.options.size > 1 %}
            <div class="rec-variants">
              {% for option in product.options %}
                {% if option.name == 'Color' %}
                <div class="color-swatches">
                  {% for value in option.values limit: 7 %}
                    <button class="color-swatch" 
                            data-color="{{ value | handleize }}" 
                            data-option-position="{{ option.position }}"
                            aria-label="{{ value }}">
                      <span class="swatch-color" style="background-color: {{ value | handleize }};"></span>
                    </button>
                  {% endfor %}
                </div>
                {% elsif option.name == 'Size' %}
                <div class="size-selector">
                  <select class="size-select" data-option-position="{{ option.position }}">
                    {% for value in option.values %}
                      <option value="{{ value }}">Size: {{ value }}</option>
                    {% endfor %}
                  </select>
                </div>
                {% endif %}
              {% endfor %}
            </div>
            {% endif %}
            
            <button class="add-to-cart-btn" data-variant-id="{{ first_variant.id }}">
              Add+
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Gift Note Section -->
  {% if block.settings.show_gift_options %}
  <div class="gift-section">
    <button class="gift-toggle">
      {{ block.settings.gift_note_text }} +
    </button>
  </div>
  {% endif %}

  <!-- Cart Footer -->
  <div class="cart-footer">
    <div class="cart-subtotal">
      <span class="subtotal-label">Subtotal</span>
      <span class="subtotal-amount">{{ cart.total_price | money }}</span>
    </div>
    
    <button class="checkout-btn" {% if cart.item_count == 0 %}disabled{% endif %}>
      {{ block.settings.checkout_text }}
    </button>
    
    {% if block.settings.show_express_checkout %}
    <div class="express-checkout">
      <button class="paypal-btn">
        <svg width="80" height="20" viewBox="0 0 80 20">
          <!-- PayPal logo SVG -->
          <path fill="#003087" d="M12.017 0L3.74 18.148h3.055l1.666-4.316h4.12c3.994 0 6.48-1.944 6.48-5.662C18.062 3.123 15.965 0 12.017 0z"/>
          <path fill="#009cde" d="M25.126 0c-1.8 0-3.275 1.474-3.275 3.275s1.474 3.275 3.275 3.275c1.8 0 3.275-1.474 3.275-3.275S26.926 0 25.126 0z"/>
        </svg>
      </button>
      
      <button class="shop-pay-btn">
        <svg width="80" height="20" viewBox="0 0 80 20">
          <!-- Shop Pay logo -->
          <rect fill="#5a31f4" width="80" height="20" rx="4"/>
          <text fill="white" font-family="system-ui" font-size="8" x="12" y="13">Shop Pay</text>
        </svg>
      </button>
    </div>
    {% endif %}
  </div>
</div>

<script src="{{ 'cart-progress.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Cart Progress & Recommendations",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Progress Bar Settings"
    },
    {
      "type": "checkbox",
      "id": "show_progress_bar",
      "label": "Show Progress Bar",
      "default": true
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold",
      "default": 50,
      "info": "Amount needed for free shipping"
    },
    {
      "type": "number",
      "id": "gift_threshold",
      "label": "Gift Threshold",
      "default": 75,
      "info": "Amount needed for free gift"
    },
    {
      "type": "text",
      "id": "gift_product_id",
      "label": "Gift Product Variant ID"
    },
    {
      "type": "number",
      "id": "discount_threshold",
      "label": "Discount Threshold",
      "default": 100
    },
    {
      "type": "text",
      "id": "discount_code",
      "label": "Discount Code"
    },
    {
      "type": "text",
      "id": "initial_message",
      "label": "Initial Progress Message",
      "default": "Add items to unlock rewards"
    },
    {
      "type": "color",
      "id": "progress_color",
      "label": "Progress Bar Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "track_color",
      "label": "Progress Track Color",
      "default": "#e5e5e5"
    },
    {
      "type": "header",
      "content": "Recommendations Settings"
    },
    {
      "type": "checkbox",
      "id": "show_recommendations",
      "label": "Show Product Recommendations",
      "default": true
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Recommendations Title",
      "default": "RECOMMENDED FOR YOU"
    },
    {
      "type": "product_list",
      "id": "recommendation_products",
      "label": "Recommended Products",
      "limit": 5,
      "info": "Select up to 5 products to recommend"
    },
    {
      "type": "header",
      "content": "Cart Settings"
    },
    {
      "type": "checkbox",
      "id": "show_gift_options",
      "label": "Show Gift Note Option",
      "default": true
    },
    {
      "type": "text",
      "id": "gift_note_text",
      "label": "Gift Note Text",
      "default": "Add Gift Note & Logo Free Packaging"
    },
    {
      "type": "text",
      "id": "checkout_text",
      "label": "Checkout Button Text",
      "default": "CHECKOUT"
    },
    {
      "type": "checkbox",
      "id": "show_express_checkout",
      "label": "Show Express Checkout Options",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "hide_when_complete",
      "label": "Hide progress bar when all rewards unlocked",
      "default": false
    }
  ]
}
{% endschema %}